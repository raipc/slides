<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Introduction to JVM performance benchmarking</title>

		<meta name="description" content="Introduction to JVM performance benchmarking">
		<meta name="author" content="Anton Rybochkin">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/default.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

        <style type="text/css">
            .reveal p {
                text-align: left;
            }
            .reveal h6 {
                text-transform: none;
            }
            .reveal .intro a:not(.image) {
                color: #eee8d5;
            }
        </style>

        <!-- If the query includes 'print-pdf', include the PDF print sheet -->
		<script>
			if( window.location.search.match( /print-pdf/gi ) ) {
				var link = document.createElement( 'link' );
				link.rel = 'stylesheet';
				link.type = 'text/css';
				link.href = 'css/print/pdf.css';
				document.getElementsByTagName( 'head' )[0].appendChild( link );
			}
		</script>
    </head>

	<body>

		<div class="reveal">

			<div class="slides">
				<section class="intro" data-transition="zoom">
					<h1>Introduction to JVM performance benchmarking</h1>
					<h2>Part 1</h2>
						<h4>By</h4>
						<h5>Anton Rybochkin</h5>
                        <I><a target="_new" href="https://twitter.com/raipcs">@raipcs</a> | <a target="_new" href="https://github.com/raipc">https://github.com/raipc</a></I><br/><br/>
                        <h6>28.05.2018</h6>
                </section>

                <section data-markdown data-transition="none">
                    <textarea data-template>
                        ## Safe Harbor Statement

The following is intended to outline our general product direction. It is intended for information purposes only, and may not be incorporated into any contract. It is not a commitment to deliver any material, code, or functionality, and should not be relied upon in making purchasing decisions. The development, release, and timing of any features or functionality described for Axibase’s products remains at the sole discretion of Axibase. The presentation is based on author's fantasies, and neither him nor Axibase company may be a target of suing, be you even my mom, the Pope, the Flying Spaghetti Monster, Santa Claus, Santa's reindeer, the President of the United States, or Hugh Jackman.
                    </textarea>
                </section>
                
                <section data-markdown data-transition="none">
                    <textarea data-template>
                        ## A minute of self-laudation
                
```csv
Benchmark                       Mode      Cnt        Score    Error   Units
parseCustomCurrentATSD        sample  3722617      504.680 ±  8.328   ns/op
parseJoda                     sample  2381165      934.201 ± 15.333   ns/op
parseOptimized                sample  2845261      142.150 ±  4.712   ns/op
printJodaIso8601              sample  3662844      509.362 ±  8.079   ns/op
printWithCustomPrinterIsoOpt  sample  2369326      271.344 ± 10.401   ns/op
```
                    </textarea>
                </section>

                <section>
                    <h2>Code lifecycle</h2>

                    <ol>
                        <li>Denial and isolation</li>
                        <li>Anger</li>
                        <li>Bargaining</li>
                        <li>Depression</li>
                        <li>Acceptance</li>
                    </ol>
                </section>

                <section>
                    <h2>Code lifecycle</h2>

                    <ol>
                        <li class="fragment">Source code</li>
                        <li class="fragment">Bytecode generated by javac</li>
                        <li class="fragment">Bytecode generated in runtime</li>
                        <li class="fragment">C1-compiled code </li>
                        <li class="fragment">C2-compiled code</li>
                    </ol>
                    <br>
                    <a class="fragment" href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/2b2511bd3cc8/src/share/vm/runtime/advancedThresholdPolicy.hpp#l34">Tiered compilation implementation details</a>
                </section>

                <section data-markdown>
                    <textarea data-template>
## JMH: Ultimate Benchmark Tool

Setup a JMH project using maven

```sh
mvn archetype:generate \
          -DinteractiveMode=false \
          -DarchetypeGroupId=org.openjdk.jmh \
          -DarchetypeArtifactId=jmh-java-benchmark-archetype \
          -DgroupId=com.github.raipc \
          -DartifactId=benchmark \
          -Dversion=1.0
```

[JMH Home page](http://openjdk.java.net/projects/code-tools/jmh/)

[Samples and documentation](http://hg.openjdk.java.net/code-tools/jmh/file/tip/jmh-samples/src/main/java/org/openjdk/jmh/samples/)
                    </textarea>
                </section>


				<section data-transition="concave" data-markdown>
                    <textarea data-template>
## Create a first benchmark

```java
@State(Scope.Benchmark)
@BenchmarkMode(Mode.AverageTime)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
public class CharIsDigitBenchmark {
    @Param(value = {"+7(955)123-45-67", "79551234567"} )
    private String input;

    @Benchmark
    public String writeDigitsCharacter() {
        final int length = input.length();
        final StringBuilder sb = new StringBuilder(length);
        for (int i = 0; i < length; i++) {
            char ch = input.charAt(i);
            if (Character.isDigit(ch)) {
                sb.append(ch);
            }
        }
        return sb.toString();
    }

    @Benchmark
    public String writeDigitsString() {
        final String digits = "0123456789";
        final int length = input.length();
        final StringBuilder sb = new StringBuilder(length);
        for (int i = 0; i < length; i++) {
            String ch = input.substring(i, i+1);
            if (digits.contains(ch)) {
                sb.append(ch);
            }
        }
        return sb.toString();
    }
}
```
                    </textarea>
				</section>

                <section data-transition="concave" data-markdown>
                    <textarea data-template>
## So, we measured the performance, what's next?

##![gif](images/confused-travolta.gif)
                    </textarea>
                </section>

                <section data-transition="concave" data-markdown>
                    <textarea data-template>
## QUIZ TIME
                    </textarea>
                </section>

                <section data-transition="concave" data-markdown>
                    <textarea data-template>
## String concatenation

```java
    @Benchmark
    public String concatOperator() {
        return first + second + third;
    }

    @Benchmark
    public String concatSb() {
        final StringBuilder sb = new StringBuilder();
        sb.append(first);
        sb.append(second);
        sb.append(third);
        return sb.toString();
    }

    @Benchmark
    public String concatSbChained() {
        return new StringBuilder().append(first)
                .append(second).append(third).toString();
    }
```

<pre><code class="fragment csv data-trim data-noescape">Benchmark         Mode  Cnt    Score   Error  Units
concatOperator    avgt    5   24.707 ± 1.104  ns/op
concatSb          avgt    5   65.194 ± 1.418  ns/op
concatSbChained   avgt    5   24.918 ± 2.054  ns/op
</code></pre>
                    </textarea>
                </section>

                <section data-transition="concave" data-markdown>
                    <textarea data-template>
## String concatenation strikes back

```java
    private String getSecondReversed() {
        return StringUtils.reverse(second);
    }

    @Benchmark
    public String concatCall() {
        return first + getSecondReversed() + third;
    }

    @Benchmark
    public String concatCallVar() {
        final String secondReversed = getSecondReversed();
        return first + secondReversed + third;
    }
```

<pre><code class="fragment csv data-trim data-noescape">Benchmark      Mode  Cnt    Score   Error  Units
concatCall     avgt    5  103.957 ± 1.727  ns/op
concatCallVar  avgt    5   61.985 ± 4.211  ns/op
</code></pre>
                    </textarea>
                </section>

                <section data-transition="concave" data-markdown>
                    <textarea data-template>
## Collection to array

```java
    @Benchmark
    public Integer[] toSizedArray() {
        return collection.toArray(new Integer[collection.size()]);
    }

    @Benchmark
    public Integer[] toUnsizedArray() {
        return collection.toArray(new Integer[0]);
    }

    @Benchmark
    public Integer[] streamToArray() {
        return collection.stream().toArray(Integer[]::new);
    }
```

<pre><code class="fragment csv data-trim data-noescape">Benchmark       Mode  Cnt      Score       Error  Units
streamToArray   avgt    5  34838.016 ± 15383.654  us/op
toSizedArray    avgt    5  30298.511 ± 24014.654  us/op
toUnsizedArray  avgt    5  27751.128 ±  5860.908  us/op
</code></pre>
                    </textarea>
                </section>

                <section data-transition="concave" data-markdown>
                    <textarea data-template>
                    ## Replace symbol in string

```java
    @Benchmark
    public String replaceUsingJdkMethod() {
        return string.replace(" ", "_");
    }

    @Benchmark
    public String replaceUsingStringUtils() {
        return StringUtils.replace(string, " ", "_");
    }
```

<pre><code class="fragment csv data-trim data-noescape">
Benchmark                Mode  Cnt    Score    Error  Units
replaceUsingJdkMethod    avgt    5  166.440 ± 54.241  ns/op
replaceUsingStringUtils  avgt    5   15.104 ±  1.852  ns/op
</code></pre>
                    </textarea>

                </section>

                <section data-transition="concave" data-markdown>
                    <textarea data-template>
## Count number of dots in a string

```java
@Benchmark
    public int countDotsInCycle() {
        if (string == null || string.isEmpty()) {
            return 0;
        }
        int count = 0;
        final int length = string.length();
        for (int i = 0; i < length; i++) {
            if ('.' == string.charAt(i)) {
                count++;
            }
        }
        return count;
    }

    @Benchmark
    public int countDotsUsingIndexOf() {
        if (string == null || string.isEmpty()) {
            return 0;
        }
        int count = 0;
        int i = -1;
        while (true){
            i = string.indexOf('.', i + 1);
            if (i == -1) {
                break;
            }
            ++count;
        }
        return count;
    }
```

<pre><code class="fragment csv data-trim data-noescape">
Benchmark              Mode  Cnt   Score   Error  Units
countDotsInCycle       avgt    5  26.688 ± 4.534  ns/op
countDotsUsingIndexOf  avgt    5  22.620 ± 1.359  ns/op
</code></pre>

<a class="fragment" href="https://gist.github.com/apangin/7a9b7062a4bd0cd41fcc">List of JVM intrinsics in Java 8</a>
                    </textarea>
                </section>

                <section data-markdown>
                    <textarea data-template>
## References

[JMH home page](http://openjdk.java.net/projects/code-tools/jmh/)

[Aleksey Shipilev's presentation about Java Benchmarking](https://www.youtube.com/watch?v=8pMfUopQ9Es)

[async-profiler home page](https://github.com/jvm-profiling-tools/async-profiler)

[Andrey Pangin's presentation about Java profiling](https://www.youtube.com/watch?v=QiGrTvsCZmA)
                    </textarea>
                </section>

				<section data-background-image="images/end.jpg">
                    <!-- The End -->
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
        <script src="js/reveal.min.js"></script>
        

		<script>
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,
				slideNumber: true,

				theme: 'moon', // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
